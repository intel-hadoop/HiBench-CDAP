<!--Created by peilunzh on 5/21/2015.
--><!DOCTYPE html>
<html>
<head>
    <title>CDAP-Bench-TeraSort</title>
    <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <!--link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"-->
    <style>
        body {
        text-align: center;
        font-family:Verdana, "Microsoft Yahei", serif;
        }
        .generate, .execute, fieldset{
        margin: 0 auto;
        width: 16.6%;
        text-align: left;
        }
        fieldset {
        width:42%;
        }

        button {
        margin-left: 60%;
        margin-top:3%;
        margin-bottom: 20px;
        }
        input,select{
        width:100%;
        margin-top:2%;
        margin-bottom:3%;
        }
        img{
        float:right;
        display: none;
        }
        table{
        width: 100%;
        text-align: right;
        }
        #tableTitle {
        text-align: center;
        }
    </style>

</head>

<body>

<h1>TeraSort</h1>

<p>TeraSort Benchmark for CDAP</p><br>

<div class="generate">
    <label for="inputPath">Input Path: </label><br>
    <input id="inputPath" placeholder="Enter Input Path"><br>

    <label for="rows">Num of Rows: </label><br>
    <input id="rows" placeholder="enter number of rows(1 row = 100 bytes)"><br>

    <button id="TeraGen" class="program" >Generate</button>
    <img id="geneimg"height="12%" width="12%" src="http://www.dabaoku.com/dabaoku/uploads/allimg/091021/2222023L0-8.gif">
</div>

<div class="execute">

    <label for="method">Data Processing Method: </label><br>
    <select id="method" >
        <option value = "mr">Hadoop MR</option>
        <option value = "spark">Spark</option>
    </select><br>

    <label for="outputPath">Output Path: </label><br>
    <input id="outputPath" placeholder="Enter Output Path"><br>
    <button id="TeraSort" class="program" disabled="disabled">Execute</button>
    <img id="execimg" height="12%" width="12%" src="http://www.dabaoku.com/dabaoku/uploads/allimg/091021/2222023L0-8.gif">
</div>

<fieldset>
    <legend>RESULT:</legend>
    <table border="1" cellspacing=".5">
        <tr id="tableTitle">
            <td>Processing Method</td>
            <td>Bench Size(Bytes)</td>
            <td>Duration(s)</td>
            <td>Throughput(Bytes/s)</td>
        </tr>
    </table>

</fieldset>




<script>
    //when click the generator
    $(document).ready(function() {
        var inputpath;
        var outputpath;
        var rows;

        //generate the data
        $("#TeraGen").click(function () {
            inputpath = $("#inputPath").val();
            rows = $("#rows").val();

            var data = {"dataset.lines.output.path":inputpath,"rows": rows};
            var stringdata = JSON.stringify(data);
            //run the mapreduce now
            console.log(stringdata);
            $.post("http://localhost:10000/v3/namespaces/default/apps/TeraSort/mapreduce/TeraGen/start",
                    stringdata
                    ,function(){
                        console.log("Data: "+ stringdata);
                    });

            $("#geneimg").show();

            //check if the job is down and enable the button
            window.setTimeout(generateFinished(),3000);

        });



        //run terasort
        $("#TeraSort").click(function () {
            outputpath = $("#outputPath").val();
            var data = {"dataset.lines.input.paths":inputpath,"dataset.counts.output.path":outputpath};
            var stringdata = JSON.stringify(data);
            console.log(stringdata);
            //start mapreduce
            $.post("http://localhost:10000/v3/namespaces/default/apps/TeraSort/mapreduce/TeraSort/start",
                    stringdata
                    ,function(){
                        console.log("Data: "+ stringdata);
                    });

            //start bench service
            $.post("http://localhost:10000/v3/namespaces/default/apps/TeraSort/services/Bench/start"
                    ,function(){
                        console.log("start bench service");
                    });
            $("#execimg").show();
            window.setTimeout(resultGet(),3000);
        })

    });
</script>






<script>
    //use this to get mapreduce status, id may equals to RandomTextWriter or WordCount
    function generateFinished(){
        var generateTimer = setInterval(function(){
            $.getJSON("http://localhost:10000/v3/namespaces/default/apps/TeraSort/mapreduce/TeraGen/status",
                    function(data){
                        if(data.status==="STOPPED"){
                            console.log(data.status);
                            $("#TeraSort").removeAttr('disabled');

                            $("#geneimg").hide();
                            clearInterval(generateTimer);
                            alert("Complete");
                        }
                    }
            );
        },500);
    }

    //get the result and show in the field set
    function resultGet(){
        var resultTimer = setInterval(function(){
            $.getJSON("http://localhost:10000/v3/namespaces/default/apps/TeraSort/mapreduce/TeraSort/status",
                    function(data){
                        if(data.status==="STOPPED"){
                            console.log(data.status);

                            $.getJSON("http://localhost:10000/v3/namespaces/default/apps/TeraSort/services/Bench/methods/benchmark",
                                    function(data){
                                        if(true){
                                            console.log(data);
                                            $("#tableTitle").after("<tr><td>"+data.processMethod+"</td><td>"+data.benchsize+"</td><td>"+data.benchduration+"</td><td>"+data.throughput+"</td></tr>");



                                            clearInterval(resultTimer);
                                            $("#execimg").hide();

                                        }
                                    }
                            );

                        }
                    }
            );
        },500);
    }

</script>



</body>



</html>